steps:  
  - name: "bhgedigital/envsubst"
    entrypoint: /bin/sh
    args:
      - '-c'
      - |
        /usr/bin/envsubst < .env.production.tmp > .env.production

  # Verify
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: /bin/sh
    args:
      - '-c'
      - |
        cat .env.production
 
    # Install
  - name: "gcr.io/fis-us/curl-nodejs-kubectl-gcloud"
    entrypoint: /bin/sh
    args:
      - '-c'
      - |
        npm install

    # Test
  - name: "gcr.io/fis-us/curl-nodejs-kubectl-gcloud"
    entrypoint: /bin/sh
    args:
      - '-c'
      - |
        curl -o account.json https://storage.googleapis.com/fis-kubeconfig/account.json
        gcloud auth activate-service-account fis-deploy@fis-us.iam.gserviceaccount.com --key-file=account.json
        gcloud container clusters get-credentials cluster-5 --region europe-west1-b
        kubectl port-forward deployment/messenger-pro 6379:6379 -n pro &
        npm test

  # docker build and push
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: /bin/sh
    args:
      - '-c'
      - |
        docker build -t gcr.io/fis-us/messenger-$BRANCH:$SHORT_SHA .
        docker push gcr.io/fis-us/messenger-$BRANCH:$SHORT_SHA

timeout: 600s